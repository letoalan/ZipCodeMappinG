<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rechercher limites de communes par code postal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;display:flex;flex-direction:column;height:100vh}
        header{padding:12px;background:#0f172a;color:#fff;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        header h1{font-size:16px;margin:0}
        #controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ccc}
        button{padding:8px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer}
        button:hover{background:#1d4ed8}
        button:disabled{background:#94a3b8;cursor:not-allowed}
        main{display:flex;flex:1;gap:12px;overflow:hidden}
        #map{flex:1;min-width:320px}
        #side{width:400px;max-width:45%;background:#fff;padding:12px;box-shadow:0 0 10px rgba(0,0,0,0.08);overflow:auto;display:flex;flex-direction:column}
        #results{margin-top:8px;flex:1;overflow:auto}
        .commune{padding:10px;border-bottom:1px solid #eee;border-radius:4px;margin-bottom:2px;position:relative}
        .commune:hover{background:#f3f4f6}
        .commune.selected{background:#dbeafe;border-left:4px solid #3b82f6}
        .commune-name{font-weight:600;color:#1f2937}
        .commune-details{font-size:12px;color:#6b7280;margin-top:4px}
        .commune-checkbox{position:absolute;right:10px;top:50%;transform:translateY(-50%)}
        .commune-content{margin-right:30px;cursor:pointer}
        .prop-sample{font-size:12px;color:#555;margin-top:4px}
        footer{padding:8px;font-size:13px;color:#555;text-align:center}
        label{font-size:13px;font-weight:500}
        select{padding:6px;border-radius:6px;border:1px solid #ccc}
        #groupControls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
        textarea{width:100%;height:120px;margin-top:8px;font-size:12px;border:1px solid #ccc;border-radius:6px;padding:8px}
        .status{padding:8px;margin:8px 0;border-radius:6px;font-size:13px}
        .status.loading{background:#dbeafe;color:#1e40af}
        .status.error{background:#fee2e2;color:#dc2626}
        .status.success{background:#d1fae5;color:#065f46}
        .search-mode{display:flex;gap:8px;align-items:center;margin:8px 0}
        .search-mode label{cursor:pointer}
        #stats{font-size:12px;color:#6b7280;margin-top:8px}
    </style>
</head>
<body>
<header>
    <h1>Limites des communes par code postal</h1>
    <div id="controls">
        <label for="postcode">Code postal :</label>
        <input id="postcode" type="text" placeholder="ex: 75001 ou 75001,75002" />
        <button id="searchBtn">Rechercher</button>
        <button id="downloadBtn" disabled>Télécharger résultats</button>
    </div>
</header>
<main>
    <div id="map"></div>
    <aside id="side">
        <div class="search-mode">
            <label><input type="radio" name="searchMode" value="postal" checked> Par code postal</label>
            <label><input type="radio" name="searchMode" value="direct"> Recherche directe</label>
        </div>

        <div id="directMode" style="display:none">
            <label for="propSelect">Propriété utilisée pour le code postal :</label>
            <select id="propSelect"></select>
            <div class="prop-sample" id="propSample"></div>
        </div>

        <div id="status"></div>

        <div id="groupControls">
            <button id="addSelectedBtn" disabled>Ajouter sélectionnées au groupe</button>
            <button id="addAllBtn" disabled>Ajouter toutes au groupe</button>
            <button id="clearGroupBtn" disabled>Vider groupe</button>
            <button id="selectAllBtn" disabled>Sélectionner tout</button>
            <button id="selectNoneBtn" disabled>Désélectionner tout</button>
        </div>

        <div id="selectionInfo" style="font-size:12px;color:#6b7280;margin-top:8px;"></div>

        <textarea id="coordsOutput" readonly placeholder="Les coordonnées des communes sélectionnées ou du groupe s'afficheront ici (GeoJSON). Vous pouvez copier-coller."></textarea>

        <div id="coordsInfo" style="font-size:12px;color:#6b7280;margin-top:4px;">
            <label><input type="radio" name="coordsMode" value="selected" checked> Afficher sélectionnées</label>
            <label><input type="radio" name="coordsMode" value="group"> Afficher groupe</label>
        </div>

        <div id="stats"></div>

        <div id="results">
            <strong>Résultats :</strong>
            <div id="list"></div>
        </div>
    </aside>
</main>
<footer>
    Placez <code>nacom.geojson</code> et <code>datanova.csv</code> dans le même dossier et servez via un serveur local (<code>python -m http.server</code>).
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
    const GEOJSON_FILE = 'nacom.geojson';
    const CSV_FILE = 'datanova.csv';

    // Setup map
    const map = L.map('map', {zoomControl:true}).setView([46.5, 2.5], 6);

    // Basemaps
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' });
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Tiles © Esri' });
    const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { attribution:'Labels © Esri', pane:'overlayPane' });

    esriSat.addTo(map);
    esriTopo.addTo(map);

    const baseLayers = {"OSM":osm, "Satellite Esri":esriSat};
    const overlays = {"Toponymes Esri":esriTopo};
    L.control.layers(baseLayers, overlays).addTo(map);

    let allFeatures = [];
    let datanovaData = new Map(); // Map: code_postal -> [{code_insee, nom_commune, ...}, ...]
    let geojsonLayer = null;
    let highlightLayer = L.layerGroup().addTo(map);
    let selectedLayer = L.layerGroup().addTo(map);
    let groupLayer = L.layerGroup().addTo(map);

    // DOM elements
    const postcodeInput = document.getElementById('postcode');
    const searchBtn = document.getElementById('searchBtn');
    const listDiv = document.getElementById('list');
    const propSelect = document.getElementById('propSelect');
    const propSample = document.getElementById('propSample');
    const downloadBtn = document.getElementById('downloadBtn');
    const addSelectedBtn = document.getElementById('addSelectedBtn');
    const addAllBtn = document.getElementById('addAllBtn');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectNoneBtn = document.getElementById('selectNoneBtn');
    const selectionInfo = document.getElementById('selectionInfo');
    const coordsInfo = document.getElementById('coordsInfo');
    const coordsModeRadios = document.querySelectorAll('input[name="coordsMode"]');
    const clearGroupBtn = document.getElementById('clearGroupBtn');
    const coordsOutput = document.getElementById('coordsOutput');
    const statusDiv = document.getElementById('status');
    const statsDiv = document.getElementById('stats');
    const directMode = document.getElementById('directMode');
    const searchModeRadios = document.querySelectorAll('input[name="searchMode"]');

    let lastMatches = [];
    let groupFeatures = [];
    let selectedFeatures = [];
    let currentCoordsMode = 'selected';
    let currentSearchMode = 'postal';

    function showStatus(message, type = 'loading') {
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        if (type === 'success' || type === 'error') {
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }
    }

    function updateStats() {
        const geoCount = allFeatures.length;
        const csvCount = datanovaData.size;
        statsDiv.innerHTML = `Données chargées: ${geoCount} communes (GeoJSON), ${csvCount} codes postaux (CSV)`;
    }

    function updateMapHighlight() {
        // Clear existing layers
        highlightLayer.clearLayers();
        selectedLayer.clearLayers();

        // Show all results in red
        if (lastMatches.length > 0) {
            const allResults = L.geoJSON(lastMatches, {
                style: {color: '#e11d48', weight: 2, fillOpacity: 0.1},
                onEachFeature: (f, l) => {
                    const name = f.properties.nom_commune || f.properties.nom || f.properties.NOM || 'Commune';
                    const code = f.properties.code_postal || f.properties.code || 'N/A';
                    const insee = f.properties.code || 'N/A';
                    l.bindPopup(`<strong>${name}</strong><br>Code postal: ${code}<br>Code INSEE: ${insee}`);
                }
            });
            allResults.addTo(highlightLayer);
        }

        // Show selected in blue (on top)
        if (selectedFeatures.length > 0) {
            const selectedResults = L.geoJSON(selectedFeatures, {
                style: {color: '#3b82f6', weight: 3, fillOpacity: 0.2},
                onEachFeature: (f, l) => {
                    const name = f.properties.nom_commune || f.properties.nom || f.properties.NOM || 'Commune';
                    const code = f.properties.code_postal || f.properties.code || 'N/A';
                    const insee = f.properties.code || 'N/A';
                    l.bindPopup(`<strong>${name}</strong><br>Code postal: ${code}<br>Code INSEE: ${insee}<br><em>Sélectionnée</em>`);
                }
            });
            selectedResults.addTo(selectedLayer);
        }
    }
    const count = selectedFeatures.length;
    const total = lastMatches.length;
    selectionInfo.textContent = `${count}/${total} commune(s) sélectionnée(s)`;

    // Update button states
    addSelectedBtn.disabled = count === 0;
    selectAllBtn.disabled = total === 0 || count === total;
    selectNoneBtn.disabled = count === 0;

    updateCoordsOutput();



    function updateCoordsOutput() {
        let features = [];
        if (currentCoordsMode === 'selected') {
            features = selectedFeatures;
        } else {
            features = groupFeatures;
        }

        if (features.length === 0) {
            coordsOutput.value = '';
            return;
        }

        const fc = {type: 'FeatureCollection', features: features};
        coordsOutput.value = JSON.stringify(fc, null, 2);
    }

    // Event listeners for search mode
    searchModeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentSearchMode = e.target.value;
            directMode.style.display = currentSearchMode === 'direct' ? 'block' : 'none';
            clearResults();
            // Event listeners for coords mode
            coordsModeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentCoordsMode = e.target.value;
                    updateCoordsOutput();
                });
            });
        });

        function showStatus(message, type = 'loading') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            if (type === 'success' || type === 'error') {
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }
        }

        function updateSelectionInfo() {
            const count = selectedFeatures.length;
            const total = lastMatches.length;
            selectionInfo.textContent = `${count}/${total} commune(s) sélectionnée(s)`;

            // Update button states
            addSelectedBtn.disabled = count === 0;
            selectAllBtn.disabled = total === 0 || count === total;
            selectNoneBtn.disabled = count === 0;

            // Update map highlighting
            updateMapHighlight();

            updateCoordsOutput();
        }

        function updateCoordsOutput() {
            let features = [];
            if (currentCoordsMode === 'selected') {
                features = selectedFeatures;
            } else {
                features = groupFeatures;
            }

            if (features.length === 0) {
                coordsOutput.value = '';
                return;
            }

            const fc = {type: 'FeatureCollection', features: features};
            coordsOutput.value = JSON.stringify(fc, null, 2);
        }
        const geoCount = allFeatures.length;
        const csvCount = datanovaData.size;
        statsDiv.innerHTML = `Données chargées: ${geoCount} communes (GeoJSON), ${csvCount} codes postaux (CSV)`;
    });

    // Parse CSV data
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const header = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        const data = new Map();

        for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            if (values.length >= 4) {
                const record = {
                    code_insee: values[0],
                    nom_commune: values[1],
                    code_postal: values[2],
                    libelle_acheminement: values[3]
                };

                const postalCode = record.code_postal;
                if (!data.has(postalCode)) {
                    data.set(postalCode, []);
                }
                data.get(postalCode).push(record);
            }
        }
        return data;
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    }

    showStatus('Chargement des données...');

    // Load data files
    Promise.all([
        fetch(GEOJSON_FILE).then(r => r.json()),
        fetch(CSV_FILE).then(r => r.text())
    ]).then(([geojson, csvText]) => {
        // Load GeoJSON
        const features = (geojson.type === 'FeatureCollection') ? geojson.features : (Array.isArray(geojson) ? geojson : []);
        allFeatures = features;
        geojsonLayer = L.geoJSON(geojson, {
            style: {weight: 1, color: '#888', fill: false}
        }).addTo(map);

        // Load CSV data
        datanovaData = parseCSV(csvText);

        // Setup property selector for direct mode
        if (allFeatures.length > 0) {
            const keys = Object.keys(allFeatures[0].properties || {});
            propSelect.innerHTML = keys.map(k => `<option value="${k}">${k}</option>`).join('');
            updatePropSample();
        }

        map.fitBounds(geojsonLayer.getBounds());
        showStatus('Données chargées avec succès', 'success');
        updateStats();

    }).catch(error => {
        console.error('Erreur lors du chargement:', error);
        showStatus('Erreur lors du chargement des données', 'error');
    });

    propSelect.addEventListener('change', updatePropSample);

    function updatePropSample() {
        const prop = propSelect.value;
        const samples = allFeatures.map(f => f.properties[prop]).filter(Boolean).slice(0, 6);
        propSample.textContent = samples.length ? 'Exemples: ' + samples.join(', ') : 'Aucun exemple.';
    }

    function parseInput(input) {
        return input.split(',').map(x => x.trim()).filter(Boolean);
    }

    function matchFeature(f, prop, codes) {
        const val = f.properties[prop];
        if (!val) return false;
        const vals = String(val).split(/[; ,]+/);
        return vals.some(v => codes.includes(v));
    }

    function findCommunesByPostalCode(postalCodes) {
        const results = [];

        for (const postalCode of postalCodes) {
            const communes = datanovaData.get(postalCode);
            if (communes) {
                for (const commune of communes) {
                    // Find corresponding feature in GeoJSON by INSEE code
                    const feature = allFeatures.find(f =>
                        f.properties.code === commune.code_insee
                    );

                    if (feature) {
                        // Add commune information to feature
                        const enrichedFeature = {
                            ...feature,
                            properties: {
                                ...feature.properties,
                                nom_commune: commune.nom_commune,
                                code_postal: commune.code_postal,
                                libelle_acheminement: commune.libelle_acheminement
                            }
                        };
                        results.push(enrichedFeature);
                    }
                }
            }
        }

        return results;
    }

    function renderResults(matches, searchMode = 'postal') {
        listDiv.innerHTML = '';
        selectedFeatures = [];

        if (!matches.length) {
            listDiv.innerHTML = '<div>Aucun résultat trouvé</div>';
            downloadBtn.disabled = true;
            addSelectedBtn.disabled = true;
            addAllBtn.disabled = true;
            selectAllBtn.disabled = true;
            selectNoneBtn.disabled = true;
            updateSelectionInfo();
            return;
        }

        // Initial map display - will be updated by updateMapHighlight
        updateMapHighlight();
        map.fitBounds(L.geoJSON(matches).getBounds());

        // Create result list with checkboxes
        matches.forEach((f, index) => {
            const div = document.createElement('div');
            div.className = 'commune';

            const name = f.properties.nom_commune || f.properties.nom || f.properties.NOM || 'Commune inconnue';
            const postalCode = f.properties.code_postal || 'N/A';
            const insee = f.properties.code || 'N/A';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'commune-checkbox';
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    if (!selectedFeatures.find(sf => sf.properties.code === f.properties.code)) {
                        selectedFeatures.push(f);
                        div.classList.add('selected');
                    }
                } else {
                    selectedFeatures = selectedFeatures.filter(sf => sf.properties.code !== f.properties.code);
                    div.classList.remove('selected');
                }
                updateSelectionInfo();
            });

            const content = document.createElement('div');
            content.className = 'commune-content';
            content.innerHTML = `
          <div class="commune-name">${name}</div>
          <div class="commune-details">
            Code postal: ${postalCode} | INSEE: ${insee}
          </div>
        `;

            content.onclick = () => {
                map.fitBounds(L.geoJSON(f).getBounds());
            };

            div.appendChild(content);
            div.appendChild(checkbox);
            listDiv.appendChild(div);
        });

        downloadBtn.disabled = false;
        addAllBtn.disabled = false;
        selectAllBtn.disabled = false;
        updateSelectionInfo();
    }

    function clearResults() {
        lastMatches = [];
        selectedFeatures = [];
        listDiv.innerHTML = '';
        highlightLayer.clearLayers();
        selectedLayer.clearLayers();
        downloadBtn.disabled = true;
        addSelectedBtn.disabled = true;
        addAllBtn.disabled = true;
        selectAllBtn.disabled = true;
        selectNoneBtn.disabled = true;
        updateSelectionInfo();
    }

    function doSearch() {
        const codes = parseInput(postcodeInput.value);
        if (!codes.length) {
            alert('Entrez au moins un code postal');
            return;
        }

        showStatus('Recherche en cours...');

        if (currentSearchMode === 'postal') {
            // Search using CSV data
            lastMatches = findCommunesByPostalCode(codes);
            renderResults(lastMatches, 'postal');
        } else {
            // Direct search in GeoJSON
            const prop = propSelect.value;
            lastMatches = allFeatures.filter(f => matchFeature(f, prop, codes));
            renderResults(lastMatches, 'direct');
        }

        if (lastMatches.length > 0) {
            showStatus(`${lastMatches.length} commune(s) trouvée(s)`, 'success');
        } else {
            showStatus('Aucune commune trouvée', 'error');
        }
    }

    // Event listeners
    searchBtn.onclick = doSearch;
    postcodeInput.onkeydown = e => {
        if (e.key === 'Enter') doSearch();
    };

    downloadBtn.onclick = () => {
        const featuresToDownload = selectedFeatures.length > 0 ? selectedFeatures : lastMatches;
        if (!featuresToDownload.length) {
            alert('Aucune commune à télécharger');
            return;
        }
        const fc = {type: 'FeatureCollection', features: featuresToDownload};
        const blob = new Blob([JSON.stringify(fc, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `communes_${selectedFeatures.length > 0 ? 'selectionnees' : 'resultats'}.geojson`;
        a.click();
        URL.revokeObjectURL(url);
    };

    addSelectedBtn.onclick = () => {
        if (!selectedFeatures.length) {
            alert('Aucune commune sélectionnée');
            return;
        }
        // Avoid duplicates by checking INSEE codes
        const existingCodes = new Set(groupFeatures.map(f => f.properties.code));
        const newFeatures = selectedFeatures.filter(f => !existingCodes.has(f.properties.code));

        groupFeatures.push(...newFeatures);
        updateGroupLayer();
        showStatus(`${newFeatures.length} commune(s) ajoutée(s) au groupe`, 'success');
    };

    addAllBtn.onclick = () => {
        if (!lastMatches.length) {
            alert('Aucun résultat à ajouter');
            return;
        }
        // Avoid duplicates by checking INSEE codes
        const existingCodes = new Set(groupFeatures.map(f => f.properties.code));
        const newFeatures = lastMatches.filter(f => !existingCodes.has(f.properties.code));

        groupFeatures.push(...newFeatures);
        updateGroupLayer();
        showStatus(`${newFeatures.length} commune(s) ajoutée(s) au groupe`, 'success');
    };

    selectAllBtn.onclick = () => {
        selectedFeatures = [...lastMatches];
        // Update checkboxes and visual state
        const checkboxes = document.querySelectorAll('.commune-checkbox');
        const communes = document.querySelectorAll('.commune');
        checkboxes.forEach((cb, i) => {
            cb.checked = true;
            communes[i].classList.add('selected');
        });
        updateSelectionInfo();
    };

    selectNoneBtn.onclick = () => {
        selectedFeatures = [];
        // Update checkboxes and visual state
        const checkboxes = document.querySelectorAll('.commune-checkbox');
        const communes = document.querySelectorAll('.commune');
        checkboxes.forEach((cb, i) => {
            cb.checked = false;
            communes[i].classList.remove('selected');
        });
        updateSelectionInfo();
    };

    clearGroupBtn.onclick = () => {
        groupFeatures = [];
        updateGroupLayer();
        showStatus('Groupe vidé', 'success');
    };

    function updateGroupLayer() {
        groupLayer.clearLayers();
        if (!groupFeatures.length) {
            clearGroupBtn.disabled = true;
            updateCoordsOutput();
            return;
        }

        const fc = {type: 'FeatureCollection', features: groupFeatures};
        L.geoJSON(fc, {
            style: {color: '#16a34a', weight: 2, fillOpacity: 0.1}
        }).addTo(groupLayer);

        clearGroupBtn.disabled = false;
        updateCoordsOutput();
    }
</script>
</body>
</html>